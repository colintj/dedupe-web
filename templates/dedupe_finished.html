{% extends 'base.html' %}
{% block content %}
    {% include "dedupe_steps.html" %}
    <h3>4. Deduping ...</h3>
    {% include "error.html" %}
    <div class="col-md-8">
        <div class='well'>
            <p>We are taking what we've learned from your training and applying it to the rest of your dataset. <strong>This may take a few minutes.</strong></p>

            <p>When finished, your deduplicated data will be available to download below.</p>
        </div>
        <div id='results'>
            <br />
            <br />
            <br />
        </div>
    </div>

{% endblock %}
{% block extra_scripts %}
<script type="text/javascript">

    function display_links(data){
        $('#results').spin(false);
        // original, training, settings, deduped
        var template = "\
            <h4>Finished!</h4>\
            <p>\
            Download your file with:\
            <br />\
            <a id='deduped-results' href='/" + data.result.deduped + "'>\
                <i class='icon-download'></i>\
                Duplicates identified\
            </a><br />\
            <a id='deduped-unique-results' href='/" + data.result.deduped_unique + "'>\
                <i class='icon-download'></i>\
                Duplicates removed\
            </a><br />\
            </p>\
            <hr />\
            <p>Are your results not quite right? When de-duplicating a file, there is a tradeoff between <a href='http://en.wikipedia.org/wiki/Precision_and_recall' target='_blank'>precision and recall</a>.</p>\
            <ul>\
                <li>If we haven't identified enough duplicates, <strong>increase</strong> the recall weight.</li>\
                <li>If we've identified duplicates to liberally, <strong>decrease</strong> the recall weight.</li>\
            </ul>\
            <p>\
                <div class='well'>\
                <p>Run dedupe again (don't worry, we still have your training info).</p>\
                <form role='form'>\
                    <label for='recall_weight'>Recall weight:</label>\
                    <select id='recall_weight'>\
                        <option val='0'>0</option>\
                        <option val='0.25'>0.25</option>\
                        <option val='0.5'>0.5</option>\
                        <option val='0.75'>0.75</option>\
                        <option val='1'>1</option>\
                        <option val='1.5'>1.5</option>\
                        <option val='2' selected=true>2</option>\
                        <option val='4'>4</option>\
                        <option val='6'>6</option>\
                        <option val='8'>8</option>\
                    </select>\
                    <button class='btn btn-primary' id='adjust_threshold'>Dedupe it again! &raquo;</button>\
                </form>\
                </div>\
            </p>";
        $('#results').html(template);
        $('#adjust_threshold').on('click', function(e){
            e.preventDefault();
            var weight = $('#recall_weight').val();
            $('#results').empty();
            $('#results').spin({'left': 0});
            $.getJSON('/adjust_threshold/', {recall_weight: weight}, function(resp){
                poll_worker();
            });
        })
    }

    function poll_worker(){
        $.ajax({
            url: '/working/',
            success: function(data){
                if (data.ready){
                    display_links(data);
                } else {
                    setTimeout(poll_worker, 3000);
                }
            },
            dataType: 'json',
        })
    }

    $('#results').spin({'left': 0});
    poll_worker();

</script>
{% endblock %}
